---
title: "Replication Paper"
author: "Miroslav Bergam"
date: "4/14/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

#### Load libraries
library(plyr)
library(stringr)
library(ggplot2)
library(boot)
library(grid)
library(RColorBrewer)
library(reshape2)
library(grid)
library(gridExtra)
library(data.table)
library(blockTools)
library(dplyr)
library(Hmisc)

```

```{r Import Data}

load("Cue-taking/zelizer_replication_data_IPC.RData")

df$t <- relevel(as.factor(df$t) , ref = 2) ### Relevel factors so control is base category; Direct treatment: -1 is advocate; 0 is control; 1 is staffer
df$t.spill <- relevel(as.factor(df$t.spill) , ref = 2) ### Indirect treatment:  -1 is advocate; 0 is control; 1 is staffer; 2 is double staffer
for(i in 1:ncol(t.for.ri)){
  t.for.ri[,i] <- relevel(as.factor(t.for.ri[,i]) , ref = 2)
  t.spill.for.ri[,i] <- relevel(as.factor(t.spill.for.ri[,i]) , ref = 2)
  cat("\r", i, "of", ncol(t.for.ri)) ### How far loop has progressed
}
df$treatment <- interaction(df$t,df$t.spill)
levels(t.for.ri[,1])
levels(t.spill.for.ri[,1])
levels(df$treatment)

```



So far, I've been able to replicate all 7 figures used in my main paper. I am still working on making the spacing and size of the graphs perfect so that they are readable (I ran into this issue with Figures 2,4, and 5). I am able to produce the content of the 5 tables of the graph but I am running into bugs when I try to visualize them in stargazer. This is something I will fix for the next milestone.  

^[[All analysis for this paper is availible at https://github.com/mirobergam/milestone-6](https://github.com/mirobergam/milestone-6)]


## Figures 
### Table 3

```{r}

### Table 3:
table3 <- subset(df , office.size > 1) %>%
  ddply(. , .(treatment) , function(x) out = data.frame(
    Weighted.Mean = round(weighted.mean(x$cosp , x$ipw),3) ,
    N = length(x$cosp))) %>%
  mutate(treatment = as.integer(treatment)) %>%
  filter(treatment == 1 | treatment == 3 | treatment == 7 | treatment == 9)

treatments3 <- tibble(treatment = c(1,3,7,9),
                      `Cue-Taking` = c("NO", "NO", "YES", "YES"),
                      Briefing = c("NO", "YES", "NO", "YES"))

table3 <- treatments3 %>% left_join(table3, by = "treatment") %>%
  select(-treatment)

table3

```

### Table 4

```{r}

# Preferred specification
estimates <- data.frame(itt = matrix(NA,nrow=3,ncol=1))
row.names(estimates) <- c("t","t.spill","t+t.spill")

estimates[1:3,] <- summary(lm(cosp ~ treatment + bill + leg ,
                              data = subset(df , office.size > 1),
                              weights=ipw))$coef[
                              c('treatment1.0','treatment0.1','treatment1.1'),
                              'Estimate']
estimates
estimates[2,1]/estimates[1,1] ### Contagion rate
nrow(subset(df , office.size > 1))

################################

ri.t <- data.frame(matrix(NA, nrow = 3 , ncol = 100))
row.names(ri.t) <- row.names(estimates)
ci.t <- ri.t
tempdf <- df

tempdf$Y0 <- df$cosp
tempdf$Y0[tempdf$treatment=="1.0"] <- tempdf$cosp[tempdf$treatment=="1.0"] -
                                            estimates[1,1]
tempdf$Y0[tempdf$treatment=="0.1"] <- tempdf$cosp[tempdf$treatment=="0.1"] -
                                            estimates[2,1]
tempdf$Y0[tempdf$treatment=="1.1"] <- tempdf$cosp[tempdf$treatment=="1.1"] -
                                            estimates[3,1]

for(i in 1:ncol(ri.t)){
  tempdf$t <- t.for.ri[,i]
  tempdf$t.spill <- t.spill.for.ri[,i]
  tempdf$ipw <- ipw.for.ri[,i]
  tempdf$treatment <- interaction(tempdf$t,tempdf$t.spill)

  ri.t[1:3,i] <- summary(lm(cosp ~ treatment + bill + leg ,
                            data = subset(tempdf , office.size > 1),
                            weights=ipw))$coef[
                            c('treatment1.0','treatment0.1','treatment1.1'),
                            'Estimate']

  tempdf$cosp1 <- tempdf$Y0
  tempdf$cosp1[tempdf$treatment=="1.0"] <- tempdf$Y0[tempdf$treatment=="1.0"] +
                                                estimates[1,1]
  tempdf$cosp1[tempdf$treatment=="0.1"] <- tempdf$Y0[tempdf$treatment=="0.1"] +
                                                estimates[2,1]
  tempdf$cosp1[tempdf$treatment=="1.1"] <- tempdf$Y0[tempdf$treatment=="1.1"] +
                                                estimates[3,1]

  ci.t[1:3,i] <- summary(lm(cosp1 ~ treatment + bill + leg ,
                            data = subset(tempdf , office.size > 1),
                            weights=ipw))$coef[
                            c('treatment1.0','treatment0.1','treatment1.1'),
                            'Estimate']
  cat("\r", i, "of", ncol(ri.t)) ### How far loop has progressed
}

########################## 


#### Table 4:
table4 <- apply(cbind.data.frame(ri.t[1:3,], estimates) , 1 , function(x)
  out = unlist(data.frame(
    Est = round(x[ncol(ri.t)+1],3),
#    mean.sim.ITT = round(mean(x[1:ncol(ri.t)]),4),
    SE = round(sd(x[1:ncol(ri.t)]),3)
#    p.one.sided = round(mean(x[1:ncol(ri.t)] > x[ncol(ri.t)+1]),4)
  )))

table4 <- as_tibble(table4)

table4 <- table4 %>%
  mutate(t = t * 100,
         t.spill = t.spill * 100, 
         `t+t.spill` = `t+t.spill` * 100) %>%
  mutate(Value = c("ITT", "SE"),
         Briefing = t,
        `Cue-Taking` = t.spill, 
        Combined = `t+t.spill`) %>%
  select(Value, Briefing, `Cue-Taking`,Combined)


```

### Table 5

```{r}

estimates <- data.frame(itt = matrix(NA,nrow=3,ncol=2))
row.names(estimates) <- c("t","t.spill","t+t.spill")
colnames(estimates) <- c("no_vote","vote")

estimates[1:3,1] <- unlist(summary(lm(cosp ~ treatment + bill + leg,
                                      data = subset(df , office.size > 1 & passed==0),
                                      weights=ipw))$coef[c('treatment1.0',
                                                           'treatment0.1',
                                                           'treatment1.1'),
                                                           'Estimate'])


estimates[1:3,2] <- unlist(summary(lm(cosp ~ treatment + bill + leg,
                                      data = subset(df , office.size > 1 & passed==1),
                                      weights=ipw))$coef[c('treatment1.0',
                                                           'treatment0.1',
                                                           'treatment1.1'),
                                                           'Estimate'])

#######################               RI           ##########################

ri.t3 <- array(NA, dim = c(3 , 2, ncol(t.spill.for.ri)),
               dimnames = list(
                 c("t","t.spill","t+t.spill"),
                 c("no_vote","vote"),
                 c(1:10000)))

for(i in 1:10){ #ncol(t.spill.for.ri)
  tempdf <- df[,c("bill","cosp","office.size","leg","passed")]
  tempdf$t <- t.for.ri[,i]
  tempdf$t.spill <- t.spill.for.ri[,i]
  tempdf$ipw <- ipw.for.ri[,i]

  tempdf$treatment <- interaction(tempdf$t,tempdf$t.spill)
  ri.t3[1:3,1,i] <- unlist(summary(lm(cosp ~ treatment + bill + leg,
                                      data = subset(tempdf , office.size > 1 & passed==0),
                                      weights=ipw))$coef[c('treatment1.0',
                                                           'treatment0.1',
                                                           'treatment1.1'),
                                                           'Estimate'])

  ri.t3[1:3,2,i] <- unlist(summary(lm(cosp ~ treatment + bill + leg,
                                      data = subset(tempdf , office.size > 1 & passed==1),
                                      weights=ipw))$coef[c('treatment1.0',
                                                           'treatment0.1',
                                                           'treatment1.1'),
                                                           'Estimate'])

  cat("\r", i, "of", ncol(t.spill.for.ri)) ### How far loop has progressed
}

### Table 5:
for(j in 1:2){
  print(colnames(estimates)[j])
  for(i in 1:3){
    print(row.names(estimates)[i])
    assign(paste0("cat", i * (j+4)), 
    data.frame(
      Est = estimates[i,j] ,
      SD = sd(ri.t3[i,j,])
    ))
  }}

table5 <- rbind(cat5, cat10, cat15, cat6, cat12, cat18) %>%
  mutate(`Reached Floor?` = c("NO","NO","NO","YES","YES","YES"),
         Condition = c("Briefing","Cue-Taking","Combined","Briefing","Cue-Taking","Combined"),
         ITT = Est * 100,
         SE = SD * 100) %>%
  select(`Reached Floor?`, Condition, ITT, SE)


```

### Table 6

```{r}

```


### Figure 3

```{r}

load("Cue-taking/zelizer_replication_data_dates_IPC.RData")

nsims <- 10 #This was at 1000 before

df$treatment <- interaction(df$t,df$t.spill)
levels(df$treatment)

nDays <- seq(0,98,7)
days.ri <- data.frame(matrix(NA,nrow=length(nDays) , ncol = 3))
days.ri.SE <- data.frame(matrix(NA,nrow=length(nDays) , ncol = 3))

for(i in nDays){
  Ydays <- as.numeric(!is.na(df$days) & df$days <= i & df$days >=0 & df$cosp==1)
  days.ri[match(i,nDays),1:3] <- summary(lm(Ydays ~ treatment + bill + leg ,
                                            data = df,
                                            weights=ipw))$coef[c('treatment1.0','treatment0.1','treatment1.1'),'Estimate']
  temp <- data.frame(matrix(NA,nrow=nsims,ncol=3))
  for(j in 1:nsims){
    treatment.sim <- interaction(t.for.ri2[,j],t.spill.for.ri2[,j])
    levels(treatment.sim)
    temp[j,1:3] <- summary(lm(Ydays ~ treatment.sim + bill + leg ,
                              data = df,
                              weights=ipw.for.ri2[,j]))$coef[c('treatment.sim1.0','treatment.sim0.1','treatment.sim1.1'),'Estimate']
  }
  temp <- apply(temp , 2 , sd)
  days.ri.SE[match(i,nDays),1:3] <- temp
  cat("\r", i, "of", nDays) ### How far loop has progressed
}

tempnum <- 1
data.frame(ATE = days.ri[,tempnum],
           CIlow = days.ri[,tempnum] - 1.65*days.ri.SE[,tempnum],
           CIhigh = days.ri[,tempnum] + 1.65*days.ri.SE[,tempnum],
           X = nDays/7) %>%
  ggplot(., aes(x = factor(X) )) +
  geom_errorbar(aes(ymin = CIlow*100 , ymax = CIhigh*100 , width = 0)) +
  geom_point(aes(y = ATE*100)) +
  scale_y_continuous(minor_breaks=waiver(), labels = waiver(), breaks=c(-2,0,2,4,6,8) , limits = c(-2,9)) +
  labs(x = "Week of Session", y = "Est. ATE (perc. pts.)") +
  geom_smooth(aes(y = ATE*100) , col = "black" , method = "loess" , se = FALSE) +
  geom_vline(xintercept=0 , color = "#535353" , lwd = 1) +
  geom_hline(yintercept=0 , color = "#535353" , lwd = 1) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_text(color = "#535353" , size = 12, face="bold"),
        axis.title.y = element_text(color = "#535353" , size = 12, face="bold"),
        axis.text.y = element_text(size = 12, colour = "grey50"),
        axis.text.x = element_text(size = 8, colour = "grey50"),
        panel.border = element_blank(),
        legend.key = element_rect(colour = "white",fill = "white"),
        legend.text = element_text(size=10,color="grey50"),
        legend.title = element_text(size = 11, face = "bold", colour = "#535353"),
        strip.text.x = element_text(size = 11, face = "bold", colour = "#535353"),
        strip.background = element_rect(colour = "white", fill = "white"),
        legend.position="right",
        plot.margin = unit(c(0.75,0.75,0.75,0.75), "cm"))


```

### Figure 4

```{r}

tempnum <- 2
data.frame(ATE = days.ri[,tempnum],
           CIlow = days.ri[,tempnum] - 1.65*days.ri.SE[,tempnum],
           CIhigh = days.ri[,tempnum] + 1.65*days.ri.SE[,tempnum],
           X = nDays/7) %>%
  ggplot(., aes(x = factor(X) )) +
  geom_errorbar(aes(ymin = CIlow*100 , ymax = CIhigh*100 , width = 0)) +
  geom_point(aes(y = ATE*100)) +
  scale_y_continuous(minor_breaks=waiver(), labels = waiver(), breaks=c(-2,0,2,4,6,8) , limits = c(-2,9)) +
  labs(x = "Week of Session", y = "Est. ATE (perc. pts.)") +
  geom_smooth(aes(y = ATE*100) , col = "black" , method = "loess" , se = FALSE) +
  geom_vline(xintercept=0 , color = "#535353" , lwd = 1) +
  geom_hline(yintercept=0 , color = "#535353" , lwd = 1) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_text(color = "#535353" , size = 12, face="bold"),
        axis.title.y = element_text(color = "#535353" , size = 12, face="bold"),
        axis.text.y = element_text(size = 12, colour = "grey50"),
        axis.text.x = element_text(size = 8, colour = "grey50"),
        panel.border = element_blank(),
        legend.key = element_rect(colour = "white",fill = "white"),
        legend.text = element_text(size=10,color="grey50"),
        legend.title = element_text(size = 11, face = "bold", colour = "#535353"),
        strip.text.x = element_text(size = 11, face = "bold", colour = "#535353"),
        strip.background = element_rect(colour = "white", fill = "white"),
        legend.position="right",
        plot.margin = unit(c(0.75,0.75,0.75,0.75), "cm"))

```


### Bibliography

@main_paper @side_paper_1 @side_paper_2 @side_paper_3 @side_paper_4
